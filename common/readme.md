# MoDT Common SDK (modt パッケージ)

MoDT (Modular Docker through MQTT) フレームワークにおいて、各ユニット間の通信規格を標準化するための共通基盤ライブラリです。従来の単一ファイル構成から役割別のモジュール分割へと移行したことで、保守性と拡張性が大幅に向上しました。すべてのユニットはこの SDK を通じてメッセージを構成することで、システム全体のプロトコル整合性を維持します。

## 概要とパッケージ構造

このライブラリは common/modt/ ディレクトリ内の複数のモジュールで構成されています。topics.py はシステム全体のトピック定数を管理し、core.py はブローカーへの接続やクライアント生成を担います。payloads.py は各通信プロトコルに準拠した JSON 生成を行い、utils.py は共通のロギングやパース処理をそれぞれ提供します。これらは __init__.py によって統合されているため、利用側は内部の分割を意識することなく、単一の入り口からすべての機能を利用できます。

## 定義されているプロトコル

通信トピックは認証・セッション関連と状態管理関連に大別されます。認証関連では成功通知やセッション照会、アプリの準備完了通知などが定義されています。状態管理関連では単一キーの取得や保存に加え、今回新しく追加された全件取得、特定のキーの削除、およびユーザーに紐付く全データの消去といった操作がサポートされました。これによりデータベースユニットに対してよりきめ細やかな操作リクエストを送信することが可能になります。

## 主要な機能とユーティリティ

クライアント管理においては、Paho MQTT のバージョン差異を吸収してオブジェクトを生成する機能や、環境変数を参照して自動的にブローカーへ接続する機能が提供されます。接続後はバックグラウンドでループが開始され、非同期通信を安定して継続できます。ペイロード処理では、すべての送信メッセージに対して自動的に ISO 8601 形式のタイムスタンプが付与され、受信側での順序制御やデバッグに役立てられます。パース処理も共通化されており、JSON フォーマットの正当性を検証した上で辞書形式として取り出すことができます。

## 実装の利点

SDK をパッケージ化したことで、特定の機能拡張が他のロジックを汚染することなく行えるようになりました。特にペイロードの生成ロジックはカプセル化されているため、将来的にメッセージ形式の仕様変更が必要になった場合でも、SDK 内部を修正するだけでシステム全体に反映されます。また、データベースユニットとのやり取りにおいて、Python ネイティブのデータ構造と JSON 間の変換を SDK が一手に引き受けるため、開発者はビジネスロジックに集中できるというメリットがあります。

## 配置と利用方法

Docker Compose 環境において、ホスト側の ./common ディレクトリを各コンテナの /app/common 等にボリュームマウントしてください。その上で PYTHONPATH に /app を含めることで、コード内からはパッケージとしてインポート可能になります。利用の際は、まずクライアントを生成してブローカーに接続し、その後は定義された定数トピックとペイロード生成関数を組み合わせて通信を行います。

```python
from common import modt

# 接続と設定の例
client = modt.get_mqtt_client("my-service")
modt.connect_broker(client)

# データ保存リクエストの例
payload = modt.create_state_set_payload("user-123", "theme", "dark")
client.publish(modt.TOPIC_STATE_SET, payload)

# データ削除リクエストの例
del_payload = modt.create_state_delete_payload("user-123", "theme")
client.publish(modt.TOPIC_STATE_DELETE, del_payload)