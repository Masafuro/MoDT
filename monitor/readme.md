# monitor unit

MoDT エコシステム内を流れるすべての MQTT メッセージをリアルタイムで監視し、人間が読みやすい形式でログ出力する専用ユニットです。

## 概要

このユニットは、MQTT ブローカーに対してワイルドカード（`#`）を用いた購読を行い、システム内のあらゆるパブリッシュイベントをキャッチします。開発時のデバッグ、シーケンスの確認、およびシステム稼働状況の監視において中心的な役割を果たします。

## 主な機能

* **全トピックの網羅的監視**: トピック名に関わらず、システム上の全メッセージをリアルタイムに取得します。
* **インテリジェント・フォーマット**: 
    * ペイロードが JSON 形式の場合：インデントを挿入し、構造化された見やすい形式で出力します。
    * ペイロードがプレーンテキスト等の場合：解析エラーを表示した上で、生のデータを出力します。
* **詳細なログメタデータ**: メッセージの受信時刻（JST/UTC実行環境に依存）と対象トピック名を明示し、セパレーター（`=`）で区切られた視認性の高いログを生成します。

## 動作原理

1. **SDKによる初期化**: `modt.py` を使用して標準化された MQTT クライアントを生成し、ブローカーへ接続します。
2. **全方位購読**: `mqtt_client.subscribe("#")` を実行し、ブローカーに届くすべてのメッセージを自身へ引き込みます。
3. **パースと出力**: 受信したペイロードを UTF-8 でデコードし、`modt.parse_payload` を介して解析を行います。
4. **リアルタイムフラッシュ**: Docker コンテナ内でのリアルタイムなログ確認を保証するため、Python の `print` 関数において `flush=True` を使用しています。

## ログ出力フォーマット例

```text
======================================================================
[2025-12-31 08:24:12] Topic: modt/state/value
----------------------------------------------------------------------
{
    "timestamp": "2025-12-31T08:24:12",
    "user_id": "2bb6f2e6-4010-4bf8-bbaf-86a455ddea19",
    "key": "theme",
    "value": "emerald-green",
    "status": "valid"
}
======================================================================
```
## 利用方法
本ユニットのログを確認するには、Docker ホスト側で以下のコマンドを実行します。

> docker-compose logs -f monitor
## 技術的特徴
- 非干渉設計: 本ユニットはトピックを受信するだけであり、他ユニットの通信に影響（メッセージの書き換えや再送）を与えることはありません。
- SDK依存: 接続ロジックやペイロードの解析処理を共通ライブラリ modt.py に委ねることで、プロトコルの変更に柔軟に対応できる設計となっています。