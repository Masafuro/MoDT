MoDTの通信基盤が正しく構築されているかを確認するための手順をまとめました。これらのコマンドは、開発方針である「内部ネットワークの閉鎖性」を維持したまま、コンテナの内部から動作を検証するためのものです。

### システムの起動と状態確認

まず最初に、プロジェクトのルートディレクトリで以下のコマンドを実行して、Mosquittoブローカーを起動します。`-d`オプションを付けることでコンテナがバックグラウンドで実行され、ターミナルを占有せずに動作を継続できます。

```bash
# コンテナの起動
docker-compose up -d

# 起動状態の確認
docker-compose ps

```

コンテナが正常に起動していることを確認したら、次にブローカーのログを表示して、設定ファイルが正しく読み込まれているか、リスナーが開始されているかをチェックします。以下のコマンドで、最新のログ出力を確認できます。

```bash
# ブローカーの動作ログ確認
docker-compose logs -f broker

```

---

### MQTTの疎通確認（Pub/Subテスト）

ブローカーが正常に動作していることが確認できたら、実際にメッセージの送受信テストを行います。MoDTでは外部にポートを開かない運用を想定しているため、`docker exec`コマンドを使用してコンテナの内部に入り、同梱されているクライアントツールを利用します。

まず、メッセージを待ち受ける「購読者（Subscriber）」を起動します。このコマンドを実行すると、ターミナルはメッセージの待機状態になります。

```bash
# メッセージの待機（別ターミナルで実行を推奨）
docker exec -it modt-broker mosquitto_sub -t "modt/test"

```

次に、別のターミナルウィンドウを開き、以下のコマンドでテストメッセージを送信（Publish）します。送信した瞬間に、先ほどの待機画面に「Hello MoDT」という文字列が表示されれば、ブローカーを介した疎結合な通信が成功している証拠です。

```bash
# テストメッセージの送信
docker exec -it modt-broker mosquitto_pub -t "modt/test" -m "Hello MoDT"

```

---

### 検証の終了

一連のテストが完了し、システムの動作に問題がないことが確認できたら、以下のコマンドでコンテナを停止します。ボリューム設定を正しく行っていれば、次回の起動時もこれまでのデータや設定を引き継ぐことが可能です。

```bash
# システムの停止
docker-compose down

```

# MoDT システム開発用 SDK コマンドリスト (PowerShell版)

このドキュメントは、Dockerコンテナ内で動作するMQTTブローカー（modt-broker）を通じて、システムの各ユニットに対して手動でメッセージを送信・監視するためのリファレンスです。PowerShell環境においてJSONのダブルクォーテーションを正しく解釈させるため、バックティック（`）によるエスケープを施しています。

---

## 1. システム全体のリアルタイム監視 (MONITOR)

デバッグ時には、まず新しいターミナルを開き、以下のコマンドを実行して全てのメッセージの流れを可視化してください。トピック名と内容がリアルタイムで表示されます。

docker exec -it modt-broker mosquitto_sub -t "modt/#" -v

---

## 2. ユーザー状態の保存 (SET)

特定のユーザー（例: user001）に対して、キーと値のペアを保存するコマンドです。データベースユニット（db-unit）はこのメッセージを受け取り、SQLiteへ内容を書き込みます。

docker exec -it modt-broker mosquitto_pub -t "modt/state/set" -m "{\`"user_id\`": \`"user001\`", \`"key\`": \`"theme\`", \`"value\`": \`"dark\`", \`"timestamp\`": \`"2025-12-31T16:00:00\`"}"

---

## 3. ユーザー状態の取得 (GET)

保存されている値を呼び出すためのリクエストコマンドです。このメッセージを送信した後、監視用ターミナルで返信用トピック（modt/state/value）に結果が流れるのを確認してください。

docker exec -it modt-broker mosquitto_pub -t "modt/state/get" -m "{\`"user_id\`": \`"user001\`", \`"key\`": \`"theme\`", \`"timestamp\`": \`"2025-12-31T16:00:00\`"}"

---

## 4. ユーザー保有キーの一覧照会 (KEYS QUERY)

対象のユーザーが現在どのような設定項目を持っているかを一括で確認したい場合に使用します。

docker exec -it modt-broker mosquitto_pub -t "modt/state/keys/query" -m "{\`"user_id\`": \`"user001\`", \`"timestamp\`": \`"2025-12-31T16:00:00\`"}"
