# dummy-app-unit 仕様書

## 概要
本ユニットは、MoDT（Modular Open Distributed Technology）エコシステムにおけるアプリケーション層の雛形として機能します。主な責務は、認証ユニット（auth-unit）から発行されるログイン成功のシグナルを購読し、それに応じてユーザーへ提供するコンテンツの準備および画面の切り替えを行うことです。

## 購読トピック
本ユニットは、システム内での認証状態の変化を検知するために、以下のトピックを常時待ち受けます。

**トピック名：** `modt/auth/success`

## 受信データ仕様（ペイロード）
認証成功時に受信するメッセージはJSON形式で構成されます。本ユニットが適切に動作するために、以下のデータが含まれている必要があります。

| 項目名 | 型 | 内容 |
| :--- | :--- | :--- |
| user_id | string | ログインしたユーザーを識別する一意のIDです。 |
| role | string | ユーザーの権限（例：admin, user）を示します。 |
| session_id | string | セッションを識別するための固有のトークンです。 |
| timestamp | string | 認証が完了した時刻の記録です。 |

## 主な仕様
このユニットは、MQTTクライアントとしての受信機能と、FlaskによるWEBサーバーとしての表示機能を併せ持っています。起動時には「待機状態」として動作し、指定されたトピックから正当な認証情報を受け取った瞬間に、内部状態を「アクティブ（お迎え状態）」へと変更します。

内部のMQTT受信ロジックはバックグラウンドで稼働し、受信したユーザー情報をメモリ内に保持します。WEBサーバー側では、このメモリ内の状態を随時参照することで、ブラウザに対して適切な画面（ログイン待機画面またはユーザー専用画面）をレスポンスとして返します。

また、本ユニットは完全に独立したDockerコンテナとして構築されるため、認証ユニットの具体的な実装言語やデータベース構成に依存することなく、メッセージの形式さえ合意されていれば、どのような環境下でも「お迎え」の役割を遂行することができます。

## 動作確認

### 1. ユニットの稼働状態を確認する
まずはシステム全体が正しく立ち上がっているかを確認します。ターミナルで docker-compose ps を実行し、modt-dummy-app コンテナの状態が Up であり、かつ 0.0.0.0:5001->5000/tcp というポートマッピングが有効になっていることを確かめてください。もしコンテナが表示されない場合は、docker-compose up -d --build を再実行して環境を構築し直します。

### 2. ブラウザで待機状態を確認する
コンテナが起動したら、ブラウザで http://localhost:5001 にアクセスしてください。この時点ではまだ認証信号が届いていないため、画面には「MoDT App Waiting...」というメッセージと、認証信号を待機している旨のステータスが表示されます。この表示が出ていることが、WEBサーバーが正常にリクエストを受け付けている証拠です。

### 3. PowerShellからテスト信号を送信する
次に、認証ユニットの代わりとなるテスト信号をMQTTブローカーへ送信します。WindowsのPowerShellを利用する場合は、引用符の解釈によるエラーを防ぐために、二重引用符の前にバックティックを付与してエスケープする必要があります。以下のコマンドを正確にコピーして実行してください。

> docker exec -it modt-broker mosquitto_pub -t "modt/auth/success" -m "{\`"user_id\`": \`"tester-01\`", \`"role\`": \`"admin\`", \`"session_id\`": \`"session-xyz-999\`", \`"timestamp\`": \`"2025-12-30\`"}"

### 4. アプリケーションの応答を確認する
コマンド実行後、ブラウザの画面を更新してください。正常に信号が処理されていれば、画面は「Active (Authenticated)」という表示に切り替わり、送信したユーザーIDやロール情報がリスト形式で表示されます。また、コンテナの内部挙動を詳しく確認したい場合は、docker logs modt-dummy-app を実行することで、MQTTの接続状況や受信した生データの内容をログとして閲覧できます。

### 5. 監視ユニットによる記録の検証
最後に、この一連の通信が monitor ユニットによって記録されているかを確認します。docker exec -it modt-monitor redis-cli lrange modt:logs 0 -1 を実行し、送信したJSONデータが時刻とともに末尾に保存されていることを確かめてください。これにより、アプリケーションの表示更新とシステムのログ記録の両方が完結したことを証明できます。