# db-unit

MoDT エコシステムにおける状態管理（KVストア）ユニットです。ユーザーごとの設定やアプリケーションの状態を SQLite データベースに永続化し、MQTT 経由で提供します。

## 概要

このユニットは、マイクロサービスアーキテクチャにおける共有データベースの役割を果たします。各ユニットはデータベースの物理的な構造を知る必要はなく、標準化された MQTT トピックを通じてデータの保存と取得を行います。

## 主な機能

* **永続的KVストレージ**: SQLite を使用し、ユーザーIDとキーを複合主キーとしたデータ保存を行います。
* **柔軟なデータ型への対応**: 数値や文字列だけでなく、辞書（dict）やリスト（list）といった複雑なデータ構造も JSON 文字列として透過的に保存・復元します。
* **一括データ提供**: 単一のキー指定による取得だけでなく、特定のユーザーに紐付くすべてのデータを一括で返信する機能を提供します。

## データベース仕様

内部では `modt_state.db` という SQLite ファイルを使用します。

### テーブル定義 (states)

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| user_id | TEXT | ユーザー固有の識別子 (Primary Key 1) |
| key | TEXT | 設定項目のキー名 (Primary Key 2) |
| value | TEXT | 保存される値（JSON文字列を含む） |
| updated_at | TIMESTAMP | 最終更新日時（自動付与） |

## 使用トピック

### 受信 (Subscribe)
* **`modt/state/get`**: 特定のキーの値を取得するリクエスト。
* **`modt/state/set`**: 値を保存または更新するリクエスト。
* **`modt/state/all/get`**: 指定したユーザーの全データを一括取得するリクエスト。
* **`modt/state/keys/query`**: 特定のユーザーが保持しているキーの一覧を照会。

### 送信 (Publish)
* **`modt/state/value`**: `get` リクエストに対する単一のデータ返信。
* **`modt/state/all/value`**: `all/get` リクエストに対する全データ（辞書形式）の返信。
* **`modt/state/keys/list`**: `keys/query` に対するキー名の配列返信。

## 実装の詳細



* **INSERT OR REPLACE**: `set` リクエスト受信時、既存のデータがあれば更新し、なければ新規作成するアップサート（Upsert）処理を行います。
* **JSON自動パース**: データベースから値を読み出す際、内容が JSON 形式であれば自動的に Python のオブジェクトにデコードして返信ペイロードを構築します。
* **スレッドセーフ設定**: `sqlite3.connect` の `check_same_thread=False` を有効にし、MQTT のコールバックスレッドから安全にデータベース操作を行えるように設計されています。

## 技術的特徴

* **SDK準拠**: トピック定数やペイロード生成はすべて共通 SDK `modt.py` に依存しており、プロトコルの統一性を維持しています。
* **ログ記録**: 保存や取得の成功状況を `modt_lib` 経由で標準出力に記録し、`monitor` ユニット等での追跡を容易にします。