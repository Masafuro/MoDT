# dummy-app-unit

MoDT エコシステムにおけるアプリケーションユニットの参照実装（リファレンスモデル）です。認証後の自動リダイレクト受諾、セッション検証、および他ユニットへの遷移デモンストレーションを担います。

## 概要

このユニットは Flask を用いた Web アプリケーションとして動作します。単独で完結するのではなく、`identify-unit` や `viewer-unit` と連携することで、マイクロサービス間のシームレスなユーザー体験を提供します。開発者が新しい業務ユニットを追加する際のテンプレートとしての役割も持っています。

## 主な機能

* **自動リダイレクト応答**: 
    * `modt/auth/success`（認証成功通知）を常時監視します。
    * 通知を検知すると、自身の公開 URL を含む `modt/app/ready` を即座に発行し、認証ユニットに対してブラウザの誘導を依頼します。
* **MQTT によるセッション検証**:
    * ブラウザから送られてくるクッキー（`modt_session_id`）が有効であるか、MQTT を介して `identify-unit` へ動的に問い合わせます。
    * 非同期な MQTT 通信の結果を同期的に待機するロジックを内蔵しており、正当なユーザーのみにコンテンツを表示します。
* **エコシステム連携**:
    * ログイン中のユーザーIDやロールを表示するダッシュボードを提供します。
    * `viewer-unit`（データ閲覧・更新コンソール）へのリンクを自動生成し、セッションを維持したままユニット間を移動する導線を提供します。

## 実装されているワークフロー



1. **待機**: 起動と同時に MQTT ブローカーに接続し、`modt/auth/success` を購読します。
2. **応答**: 誰かがログインに成功したメッセージを受け取ると、そのセッションIDをキーとして「準備完了」メッセージをパブリッシュします。
3. **検証**: ブラウザが自身のトップページ（`/`）に到達すると、ブラウザが持つクッキーを使って身元照会を行います。
4. **表示**: 身元が確認されればユーザー情報を画面に表示し、確認できなければログイン画面への誘導を表示します。

## エンドポイント仕様

### 1. GET `/` (Index)
メインダッシュボード画面です。
* クッキーからセッションIDを読み取り、`verify_session_via_mqtt` 関数を実行します。
* 認証済みであればユーザーIDと権限を表示し、未認証であればログインを促すメッセージを表示します。

### 2. GET `/logout`
ログアウト処理を行います。
* ブラウザのクッキー（`modt_session_id`）を削除（有効期限を0に設定）します。
* 環境変数で指定された `IDENTIFY_PUBLIC_URL` のログインページへリダイレクトします。

## 必須環境変数

実行には以下の環境設定が必要です。

* `IDENTIFY_PUBLIC_URL`: 認証ユニットの外部公開 URL（ログアウト時の遷移先）。
* `DUMMY_APP_PUBLIC_URL`: 自身の外部公開 URL（準備完了通知で使用）。
* `VIEWER_PUBLIC_URL`: データ閲覧ユニットの外部公開 URL（リンク生成で使用）。

## 使用トピック

### 受信 (Subscribe)
* `modt/auth/success`: ログイン成功イベントの検知用。
* `modt/session/info`: セッション照会に対する回答受信用。

### 送信 (Publish)
* `modt/app/ready`: 自身へのリダイレクトを要求する通知。
* `modt/session/query`: 提示されたセッションIDの妥当性確認リクエスト。

## 技術的特徴

* **堅牢な設定チェック**: 起動時に `get_env_or_raise` 関数を用いて必須環境変数の存在を確認し、設定漏れによるランタイムエラーを防止します。
* **ポーリング待機**: MQTT の非同期応答を待機するために、タイムアウト付きの `while` ループによるレスポンスチェックを実装しています。
* **SDK 準拠**: ペイロードの生成や解析にはすべて共通 SDK `modt.py` を使用しています。