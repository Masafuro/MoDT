# MoDT
MQTTを基盤とした、Dockerコンテナによるポン付け可能な疎結合アプリケーションフレームワーク

## 開発進捗
- 令和7年12月30日
  - dummy-app-unitの動作確認まで行った。
  - 次はログインユニットの構築
  - 

## プロトコル

```md

# MoDT通信プロトコル仕様書：標準リダイレクトフロー

## 1. 概要

本プロトコルは、認証ユニット（identify-unit）がユーザーを特定した後、適切なアプリケーションユニットへ処理を引き継ぎ、最終的にユーザーのブラウザを自動的に遷移させるまでの一連のやり取りを規定するものです。すべてのメッセージはMQTTブローカーを介して非同期に送受信され、JSON形式で記述されます。

## 2. 認証成功イベント（Authentication Success）

ユーザーが認証ユニットでのログインに成功した際、システム全体に対して「誰が、どのセッションでログインしたか」を通知するためのメッセージです。

### 配信詳細

* **トピック名**: `modt/auth/success`
* **発行元**: 認証ユニット（identify-unitなど）
* **主な受信先**: アプリケーションユニット、モニターユニット

### ペイロード仕様

メッセージは以下のキーを含むJSONオブジェクトで構成されます。

* **user_id**: データベース上のユーザー固有識別子を文字列で指定します。
* **session_id**: ブラウザとのWebSocket接続を維持し、リダイレクト先を特定するためのUUID形式の文字列です。
* **role**: ユーザーの権限レベル（user, adminなど）を示します。
* **timestamp**: ISO 8601形式のイベント発生時刻です。

## 3. アプリケーション準備完了通知（Application Readiness）

アプリケーションユニットが認証成功イベントを受け取り、自ユニットでの受け入れ準備（コンテナの起動やセッション作成など）を完了したことを認証ユニットへ伝えるためのメッセージです。

### 配信詳細

* **トピック名**: `modt/app/ready`
* **発行元**: アプリケーションユニット（dummy-app-unitなど）
* **主な受信先**: 認証ユニット、モニターユニット

### ペイロード仕様

認証ユニットが正しくリダイレクト先を識別できるよう、以下のキー名を厳格に使用する必要があります。

* **session_id**: 認証成功イベントから引き継いだセッション識別子です。認証ユニットはこの値をキーにしてWebSocket接続を特定します。
* **redirect_url**: ユーザーのブラウザが最終的に遷移すべきフルパスのURLを指定します。
* **app_name**: 通知を発行したアプリケーションユニットの識別名です。

## 4. 技術的実装要件

各ユニットの実装において遵守すべき技術的な制約事項は以下の通りです。

### データ形式と型

すべてのメッセージはUTF-8でエンコードされた純粋なJSON形式でなければなりません。キー名および文字列の値は必ず二重引用符（"）で囲む必要があります。数値や真偽値を除き、単一引用符（'）や引用符のない文字列はJSONとして不正とみなされ、認証ユニット側で破棄されます。

### ネットワークと同期

リダイレクトの待機にはWebSocket（プロトコル：wsまたはwss）を利用します。認証ユニットはWebSocket接続を受け取った後、メモリ上に保持されたセッションIDと、MQTT経由で届く準備完了通知のセッションIDを照合します。一致が確認された瞬間に、接続中のWebSocketを通じてリダイレクト先URLがブラウザへプッシュ送信されます。

### エラー処理

必須キー（特にsession_idとredirect_url）が欠落しているメッセージを受信した場合、認証ユニットはセキュリティと整合性の観点からそのメッセージを無視し、処理を続行しません。アプリケーションユニットは、確実にこれらの情報をペイロードに含める責務を負います。

```

---

## 3. 監視とログ記録 (Monitoring and Logging)

モニターユニット（monitor）は、上記のすべてのトピックをワイルドカード `modt/#` を用いて網羅的に購読します。受信したすべてのメッセージは、発生時刻とトピック名を付与された状態で、Redisなどの高速な記録層に永続化されます。これにより、どのタイミングで誰がログインし、どのアプリがそれに応答したかという、システム全体の「対話の履歴」をリアルタイムで追跡することが可能になります。


```


## 開発方針
- 各モジュールはdockerイメージになること
- 各モジュールはmqttによる通信によって連携すること
- VPSを想定し、mosquittoを内部のみに開くこと

## 開発概要
- broker
  - mosquittoの設定ファイル等
  - docker-compose.ymlによってmosquittoが組み込まれる。
- monitor
  - redisに流れてきたデータを格納する。
- dummy-app-unit
  - 認証情報が来たらサーバー側の表示を変更する。
  - mqttにリダイレクト先情報を送信する。
