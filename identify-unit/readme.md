# identify-unit

MoDT エコシステムの入り口（認証基盤）であり、ユーザーの登録・認証、およびセッションとユーザーIDの紐付けを一元管理するユニットです。

## 概要

このユニットは FastAPI を用いた Web サーバーとして動作し、ユーザーにログイン・新規登録画面を提供します。認証に成功すると、一時的なセッションIDを発行し、MQTT を介してシステム全体へ通知します。また、他ユニットからの「このセッションIDは誰か？」という問い合わせ（身分照会）に答える権限管理サーバーとしても機能します。

## 主な機能

* **ユーザー認証・管理**:
    * 新規ユーザー登録（パスワードの bcrypt ハッシュ化保存）。
    * ログイン処理および UUID によるセッションIDの発行。
    * Cookie によるセッション維持（HttpOnly / SameSite 属性付与）。
* **リダイレクト制御（オーケストレーション）**:
    * ログイン成功後、アプリ側の受け入れ準備（`modt/app/ready`）を監視。
    * WebSocket を用いて、ブラウザを適切なアプリケーション URL へ自動遷移。
* **アイデンティティ・プロバイダー**:
    * 他ユニットからの身分照会（`modt/session/query`）に対し、有効なユーザーIDとロールを回答。

## エンドポイント仕様

### HTTP API
* **GET `/login` / `/register`**: 認証画面の提供。
* **POST `/register`**: 新規ユーザーの永続化（データベース保存）。
* **POST `/login`**: 認証処理。成功時に `modt/auth/success` をパブリッシュ。
* **GET `/waiting`**: アプリケーションの準備が整うまでユーザーを待機させる画面。

### WebSocket
* **WS `/ws/{session_id}`**: 待機画面で使用。アプリ側の準備が整い次第、リダイレクト先 URL をブラウザに送信。

## 使用トピック

### 受信 (Subscribe)
* **`modt/app/ready`**: アプリケーション側からの受け入れ準備完了通知。これを受けて WebSocket 経由でリダイレクトを実行します。
* **`modt/session/query`**: 他ユニット（viewer-unit 等）からのセッション確認リクエスト。

### 送信 (Publish)
* **`modt/auth/success`**: ログイン成功通知。システム全体に新しいセッションの開始を知らせます。
* **`modt/session/info`**: セッション照会に対する回答。有効なセッションであれば `user_id` と `role` を返します。

## リダイレクトの仕組み

1. ユーザーがログインに成功すると、`identify-unit` が **`modt/auth/success`** を発行。
2. 対象のアプリケーション（例: `dummy-app-unit`）がそれを検知し、自身の公開URLを含めた **`modt/app/ready`** を発行。
3. `identify-unit` が準備完了を検知し、待機画面（WebSocket）へ URL を送信。
4. ブラウザが自動的にアプリ画面へリダイレクト。

## 技術的特徴

* **非同期処理の同期**: WebSocket と MQTT を組み合わせることで、本来非同期なマイクロサービス間のイベント連鎖を、ユーザーのブラウザ体験として同期的な遷移に変換しています。
* **メモリキャッシュと DB の併用**: 永続的なユーザーデータはデータベース（SQLAlchemy）で管理し、一時的なセッション状態（`ready_apps`, `active_sessions`）はメモリ上で高速に処理します。
* **SDKによる標準化**: メッセージの生成には共通 SDK `modt.py` を使用し、ペイロード構造の厳格な準拠を保証しています。